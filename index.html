<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Tracker Pro v3.0</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #bb86fc; --text: #ffffff; --nav: #252525; --gray: #888; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav); display: flex; justify-content: space-around; padding: 10px 5px; border-top: 1px solid #333; z-index: 100; }
        .nav-item { background: none; border: none; color: var(--gray); font-size: 0.65rem; cursor: pointer; text-transform: uppercase; padding: 10px 5px; border-radius: 8px; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--accent); background: rgba(187, 134, 252, 0.1); font-weight: bold; }
        .header { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 20px; }
        .view { display: none; }
        .view.active { display: block; }
        input, textarea, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #2c2c2c; color: white; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; }
        label { display: block; margin-top: 15px; font-size: 0.8rem; text-transform: uppercase; color: var(--gray); }
        .tag { padding: 10px 15px; background: #333; border-radius: 12px; font-size: 0.9rem; cursor: pointer; border: 1px solid transparent; display: inline-block; margin: 4px; }
        .tag.selected { background: var(--accent); color: black; font-weight: bold; }
        .db-form { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .db-item { background: var(--card); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent); }
        .details-pane { background: #252525; padding: 10px; border-radius: 5px; margin-top: 8px; font-size: 0.85rem; color: var(--gray); border: 1px dashed #444; pointer-events: none; }
        .del-btn { color: #ff5252; cursor: pointer; font-size: 0.8rem; float: right; margin-left: 15px; }
        .edit-btn { color: var(--accent); cursor: pointer; font-size: 0.8rem; float: right; }
        .save-btn { width: 100%; padding: 18px; background: var(--accent); border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; color: black; font-size: 1.1rem; }
        .stats-container { display: flex; flex-direction: column; gap: 15px; }
        .stats-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #444; }
        .filter-group { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 8px 12px; background: #333; border-radius: 20px; font-size: 0.75rem; border: none; color: white; white-space: nowrap; }
        .filter-btn.active { background: var(--accent); color: black; font-weight: bold; }
    </style>
</head>
<body>

    <div id="view-saisie" class="view active">
        <div class="header">Nouvelle Entr√©e</div>
        <label>Date</label>
        <input type="date" id="entry-date">
        <label>1. O√π √ßa ?</label><div id="input-places" class="select-area"></div>
        <label>2. Quel √âv√©nement ? (Optionnel)</label><div id="input-events" class="select-area"></div>
        <label>3. Avec Qui ?</label><div id="input-people" class="select-area"></div>
        <button class="save-btn" onclick="saveEntry()">ENREGISTRER</button>
    </div>

    <div id="view-db" class="view">
        <div id="form-container" class="db-form"></div>
        <div id="db-list"></div>
    </div>

    <div id="view-resume" class="view">
        <div class="header">Statistiques</div>
        <div class="filter-group">
            <button class="filter-btn active" onclick="setStatFilter('week', this)">Semaine</button>
            <button class="filter-btn" onclick="setStatFilter('month', this)">Mois</button>
            <button class="filter-btn" onclick="setStatFilter('year', this)">Ann√©e</button>
            <button class="filter-btn" onclick="setStatFilter('all', this)">Toujours</button>
        </div>
        <div id="stats-content" class="stats-container"></div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="showView('saisie')">Saisie</button>
        <button class="nav-item" onclick="showView('db', 'places')">Lieux</button>
        <button class="nav-item" onclick="showView('db', 'events')">√âv√©nements</button>
        <button class="nav-item" onclick="showView('db', 'people')">Personnes</button>
        <button class="nav-item" onclick="showView('resume')">R√©sum√©</button>
    </nav>

    <script>
        let currentDBType = '';
        let editingId = null;
        let openDetailId = null;
        let statFilter = 'week';
        let dbs = {
            places: JSON.parse(localStorage.getItem('db_places_v3') || "[]"),
            events: JSON.parse(localStorage.getItem('db_events_v3') || "[]"),
            people: JSON.parse(localStorage.getItem('db_people_v3') || "[]")
        };
        let history = JSON.parse(localStorage.getItem('tracker_history_v3') || "[]");
        let selections = { places: '', events: '', people: [] };

        function init() { document.getElementById('entry-date').valueAsDate = new Date(); renderSaisie(); }

        function showView(viewId, dbType = '') {
            editingId = null;
            document.querySelectorAll('.view, .nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            if(dbType) { 
                currentDBType = dbType; renderDBForm(); renderDBList();
                document.querySelectorAll('.nav-item').forEach(n => { if(n.innerText.toLowerCase().includes(dbType)) n.classList.add('active'); });
            } else {
                document.querySelectorAll('.nav-item').forEach(n => { if(n.innerText.toLowerCase().includes(viewId)) n.classList.add('active'); });
            }
            if(viewId === 'saisie') renderSaisie();
            if(viewId === 'resume') renderStats();
        }

        function renderDBForm() {
            const container = document.getElementById('form-container');
            let html = `<strong>Nouvelle entr√©e</strong><br><br>`;
            if (currentDBType === 'people') {
                html += `<input type="text" id="f-nom" placeholder="Nom complet"><input type="text" id="f-alias" placeholder="Alias">
                         <input type="text" id="f-addr" placeholder="Adresse"><input type="tel" id="f-tel" placeholder="T√©l√©phone">
                         <input type="text" id="f-insta" placeholder="@ Instagram"><label>Anniversaire</label><input type="date" id="f-birth">`;
            } else if (currentDBType === 'places') {
                html += `<input type="text" id="f-nom" placeholder="Nom du lieu"><input type="text" id="f-addr" placeholder="Adresse">`;
            } else if (currentDBType === 'events') {
                html += `<input type="text" id="f-nom" placeholder="Nom de l'√©v√©nement"><textarea id="f-desc" placeholder="Description"></textarea>`;
            }
            html += `<button class="save-btn" style="padding:10px;" onclick="saveToDB()">${editingId ? 'Mettre √† jour' : 'Ajouter √† la base'}</button>`;
            if(editingId) html += `<button class="save-btn" style="padding:10px; background:#555; margin-top:5px;" onclick="editingId=null;renderDBForm()">Annuler</button>`;
            container.innerHTML = html;
        }

        function saveToDB() {
            const nom = document.getElementById('f-nom').value.trim();
            if(!nom) return;
            let item = editingId ? dbs[currentDBType].find(i => i.id === editingId) : { id: Date.now() };
            item.nom = nom;
            item.alias = (currentDBType === 'people') ? document.getElementById('f-alias').value.trim() : nom;
            ['adresse', 'tel', 'insta', 'anniv', 'description'].forEach(field => {
                const el = document.getElementById('f-' + (field === 'adresse' ? 'addr' : field === 'anniv' ? 'birth' : field === 'description' ? 'desc' : field));
                if(el) item[field] = el.value;
            });
            if(!editingId) dbs[currentDBType].push(item);
            localStorage.setItem('db_'+currentDBType+'_v3', JSON.stringify(dbs[currentDBType]));
            editingId = null; renderDBForm(); renderDBList();
        }

        function renderDBList() {
            document.getElementById('db-list').innerHTML = dbs[currentDBType].map(item => `
                <div class="db-item" onclick="toggleDetail(${item.id})">
                    <span class="del-btn" onclick="event.stopPropagation();deleteDBItem(${item.id})">Supprimer</span>
                    <span class="edit-btn" onclick="event.stopPropagation();startEditDB(${item.id})">Modifier</span>
                    <strong>${item.alias}</strong>
                    ${openDetailId === item.id ? `<div class="details-pane">
                        ${item.nom ? `Nom: ${item.nom}<br>` : ''}${item.adresse ? `üìç ${item.adresse}<br>` : ''}
                        ${item.tel ? `üìû ${item.tel}<br>` : ''}${item.insta ? `üì∏ ${item.insta}<br>` : ''}
                        ${item.anniv ? `üéÇ ${item.anniv}<br>` : ''}${item.description ? `üìù ${item.description}` : ''}
                    </div>` : ''}
                </div>
            `).join('');
        }

        function toggleDetail(id) { openDetailId = (openDetailId === id) ? null : id; renderDBList(); }
        function startEditDB(id) { 
            editingId = id; renderDBForm(); 
            const item = dbs[currentDBType].find(i => i.id === id);
            document.getElementById('f-nom').value = item.nom;
            if(currentDBType === 'people') document.getElementById('f-alias').value = item.alias;
            window.scrollTo(0,0);
        }

        function renderSaisie() {
            ['places', 'events', 'people'].forEach(type => {
                const container = document.getElementById('input-' + type);
                container.innerHTML = ''; 
                dbs[type].forEach(item => {
                    const btn = document.createElement('div');
                    btn.className = 'tag ' + ((type === 'people' ? selections[type].includes(item.alias) : selections[type] === item.alias) ? 'selected' : '');
                    btn.innerText = item.alias;
                    btn.onclick = () => selectTag(type, item.alias);
                    container.appendChild(btn);
                });
            });
        }

        function selectTag(type, val) {
            if(type === 'people') {
                const idx = selections[type].indexOf(val);
                idx > -1 ? selections[type].splice(idx, 1) : selections[type].push(val);
            } else {
                selections[type] = (selections[type] === val) ? '' : val;
            }
            renderSaisie();
        }

        function saveEntry() {
            if(!selections.places) return alert("Lieu obligatoire");
            history.push({ id: Date.now(), date: document.getElementById('entry-date').value, event: selections.events || "Aucun", place: selections.places, people: [...selections.people] });
            localStorage.setItem('tracker_history_v3', JSON.stringify(history));
            alert("Enregistr√© !");
            selections = { places: '', events: '', people: [] }; renderSaisie();
        }

        function setStatFilter(f, btn) {
            statFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderStats();
        }

        function renderStats() {
            const now = new Date();
            const filtered = history.filter(e => {
                const d = new Date(e.date);
                if(statFilter === 'week') return (now - d) < 7 * 86400000;
                if(statFilter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                if(statFilter === 'year') return d.getFullYear() === now.getFullYear();
                return true;
            });

            const pCount = {}, lCount = {};
            filtered.forEach(e => {
                lCount[e.place] = (lCount[e.place] || 0) + 1;
                e.people.forEach(p => pCount[p] = (pCount[p] || 0) + 1);
            });

            let html = `<div class="stats-card"><strong>Lieux Fr√©quent√©s</strong><br><br>`;
            Object.entries(lCount).sort((a,b) => b[1]-a[1]).forEach(([n, c]) => html += `<div class="stat-row"><span>${n}</span><strong>${c} fois</strong></div>`);
            html += `</div><div class="stats-card"><strong>Personnes Vues</strong><br><br>`;
            Object.entries(pCount).sort((a,b) => b[1]-a[1]).forEach(([n, c]) => html += `<div class="stat-row"><span>${n}</span><strong>${c} fois</strong></div>`);
            html += `</div>`;
            document.getElementById('stats-content').innerHTML = html;
        }

        function deleteDBItem(id) { if(confirm("Supprimer ?")) { dbs[currentDBType] = dbs[currentDBType].filter(i => i.id !== id); localStorage.setItem('db_'+currentDBType+'_v3', JSON.stringify(dbs[currentDBType])); renderDBList(); } }

        init();
    </script>
</body>
</html>
