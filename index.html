<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Tracker Pro</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #bb86fc; --text: #ffffff; --nav: #252525; --gray: #888; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; }
        
        /* Navigation avec surbrillance */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav); display: flex; justify-content: space-around; padding: 10px 5px; border-top: 1px solid #333; z-index: 100; }
        .nav-item { background: none; border: none; color: var(--gray); font-size: 0.65rem; cursor: pointer; text-transform: uppercase; padding: 10px 5px; border-radius: 8px; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--accent); background: rgba(187, 134, 252, 0.1); font-weight: bold; }

        .header { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 20px; }
        .view { display: none; }
        .view.active { display: block; }

        /* Formulaires & Inputs */
        input, textarea, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #2c2c2c; color: white; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; }
        label { display: block; margin-top: 15px; font-size: 0.8rem; text-transform: uppercase; color: var(--gray); }
        
        .tag { padding: 10px 15px; background: #333; border-radius: 12px; font-size: 0.9rem; cursor: pointer; border: 1px solid transparent; }
        .tag.selected { background: var(--accent); color: black; font-weight: bold; }
        .select-area { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

        /* DB Management */
        .db-form { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        .db-item { background: var(--card); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent); position: relative; }
        .delete-btn { color: #ff5252; float: right; font-size: 0.8rem; cursor: pointer; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stats-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .stat-val { font-size: 1.4rem; font-weight: bold; color: var(--accent); display: block; }
        .stat-label { font-size: 0.7rem; color: var(--gray); text-transform: uppercase; }
        
        .ranking-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 0.9rem; }

        .save-btn { width: 100%; padding: 18px; background: var(--accent); border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; color: black; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="view-saisie" class="view active">
        <div class="header">Nouvelle Entr√©e</div>
        <label>Date</label>
        <input type="date" id="entry-date">
        
        <label>1. √âv√©nement</label>
        <div id="input-events" class="select-area"></div>

        <label>2. Avec Qui ?</label>
        <div id="input-people" class="select-area"></div>

        <label>3. O√π √ßa ?</label>
        <div id="input-places" class="select-area"></div>

        <button class="save-btn" onclick="saveEntry()">ENREGISTRER</button>
    </div>

    <div id="view-db" class="view">
        <div class="header" id="db-title">Base de donn√©es</div>
        
        <div id="form-container" class="db-form">
            </div>

        <div id="db-list"></div>
    </div>

    <div id="view-resume" class="view">
        <div class="header">Statistiques & R√©sum√©s</div>
        
        <label>P√©riode d'analyse</label>
        <select id="stats-period" onchange="renderStats()">
            <option value="all">Depuis toujours</option>
            <option value="year">Cette ann√©e</option>
            <option value="month">Ce mois-ci</option>
            <option value="week">Cette semaine</option>
        </select>

        <div class="stats-grid">
            <div class="stats-card"><span id="stat-total" class="stat-val">0</span><span class="stat-label">Sorties</span></div>
            <div class="stats-card"><span id="stat-unique-people" class="stat-val">0</span><span class="stat-label">Personnes</span></div>
        </div>

        <div class="header" style="font-size: 1rem;">Top Fr√©quentation</div>
        <div id="stats-rankings"></div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="showView('saisie')">Saisie</button>
        <button class="nav-item" onclick="showView('db', 'places')">Lieux</button>
        <button class="nav-item" onclick="showView('db', 'events')">√âv√©nements</button>
        <button class="nav-item" onclick="showView('db', 'people')">Personnes</button>
        <button class="nav-item" onclick="showView('resume')">R√©sum√©</button>
    </nav>

    <script>
        let currentDBType = '';
        let dbs = {
            places: JSON.parse(localStorage.getItem('db_places_full') || "[]"),
            events: JSON.parse(localStorage.getItem('db_events_full') || "[]"),
            people: JSON.parse(localStorage.getItem('db_people_full') || "[]")
        };
        let selections = { places: '', events: '', people: [] };
        let history = JSON.parse(localStorage.getItem('tracker_history_v2') || "[]");

        function init() {
            document.getElementById('entry-date').valueAsDate = new Date();
            renderSaisie();
        }

        function showView(viewId, dbType = '') {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('view-' + viewId).classList.add('active');
            
            // Gestion de la surbrillance
            const btnText = dbType ? dbType : viewId;
            document.querySelectorAll('.nav-item').forEach(btn => {
                if(btn.innerText.toLowerCase().includes(btnText.toLowerCase())) btn.classList.add('active');
            });

            if (dbType) {
                currentDBType = dbType;
                renderDBForm();
                renderDBList();
            }
            if (viewId === 'saisie') renderSaisie();
            if (viewId === 'resume') renderStats();
        }

        // --- GESTION BASES DE DONN√âES ---
        function renderDBForm() {
            const container = document.getElementById('form-container');
            let html = `<strong>Ajouter : ${currentDBType}</strong><br><br>`;
            
            if (currentDBType === 'places') {
                html += `<input type="text" id="f-nom" placeholder="Nom du lieu">
                         <input type="text" id="f-addr" placeholder="Adresse">`;
            } else if (currentDBType === 'people') {
                html += `<input type="text" id="f-nom" placeholder="Nom complet">
                         <input type="text" id="f-addr" placeholder="Adresse">
                         <input type="tel" id="f-tel" placeholder="T√©l√©phone">
                         <input type="text" id="f-insta" placeholder="@ Instagram">
                         <label>Anniversaire</label><input type="date" id="f-birth">`;
            } else if (currentDBType === 'events') {
                html += `<input type="text" id="f-nom" placeholder="Nom de l'√©v√©nement">
                         <textarea id="f-desc" placeholder="Description"></textarea>`;
            }
            
            html += `<button class="save-btn" style="padding:10px;margin-top:5px" onclick="addToDB()">Ajouter √† la base</button>`;
            container.innerHTML = html;
        }

        function addToDB() {
            const newItem = { id: Date.now(), nom: document.getElementById('f-nom').value };
            if(!newItem.nom) return alert("Le nom est obligatoire");

            if(currentDBType === 'places') newItem.adresse = document.getElementById('f-addr').value;
            if(currentDBType === 'events') newItem.description = document.getElementById('f-desc').value;
            if(currentDBType === 'people') {
                newItem.adresse = document.getElementById('f-addr').value;
                newItem.tel = document.getElementById('f-tel').value;
                newItem.insta = document.getElementById('f-insta').value;
                newItem.anniv = document.getElementById('f-birth').value;
            }

            dbs[currentDBType].push(newItem);
            localStorage.setItem('db_'+currentDBType+'_full', JSON.stringify(dbs[currentDBType]));
            renderDBForm();
            renderDBList();
        }

        function renderDBList() {
            const list = document.getElementById('db-list');
            list.innerHTML = dbs[currentDBType].map(item => `
                <div class="db-item">
                    <span class="delete-btn" onclick="deleteItem(${item.id})">Supprimer</span>
                    <strong>${item.nom}</strong><br>
                    <small style="color:var(--gray)">${item.adresse || item.description || ''}</small>
                </div>
            `).join('');
        }

        function deleteItem(id) {
            if(confirm("Supprimer cet √©l√©ment ?")) {
                dbs[currentDBType] = dbs[currentDBType].filter(i => i.id !== id);
                localStorage.setItem('db_'+currentDBType+'_full', JSON.stringify(dbs[currentDBType]));
                renderDBList();
            }
        }

        // --- GESTION SAISIE ---
        function renderSaisie() {
            renderTagCloud('events', 'single');
            renderTagCloud('people', 'multi');
            renderTagCloud('places', 'single');
        }

        function renderTagCloud(type, mode) {
            const container = document.getElementById('input-' + type);
            if(dbs[type].length === 0) {
                container.innerHTML = `<small style="color:var(--gray)">Allez dans l'onglet ${type} pour ajouter des donn√©es.</small>`;
                return;
            }
            container.innerHTML = dbs[type].map(item => {
                const isSelected = mode === 'single' ? selections[type] === item.nom : selections[type].includes(item.nom);
                return `<div class="tag ${isSelected ? 'selected' : ''}" onclick="selectTag('${type}', '${item.nom}', '${mode}')">${item.nom}</div>`;
            }).join('');
        }

        function selectTag(type, val, mode) {
            if(mode === 'single') selections[type] = (selections[type] === val) ? '' : val;
            else {
                const idx = selections[type].indexOf(val);
                if(idx > -1) selections[type].splice(idx, 1);
                else selections[type].push(val);
            }
            renderSaisie();
        }

        function saveEntry() {
            if(!selections.events || !selections.places) return alert("Veuillez s√©lectionner au moins un √©v√©nement et un lieu.");
            const entry = {
                id: Date.now(),
                date: document.getElementById('entry-date').value,
                event: selections.events,
                place: selections.places,
                people: [...selections.people]
            };
            history.push(entry);
            localStorage.setItem('tracker_history_v2', JSON.stringify(history));
            alert("Journ√©e enregistr√©e !");
            selections = { places: '', events: '', people: [] };
            renderSaisie();
        }

        // --- STATISTIQUES ---
        function renderStats() {
            const period = document.getElementById('stats-period').value;
            const now = new Date();
            
            const filtered = history.filter(e => {
                if(period === 'all') return true;
                const eDate = new Date(e.date);
                if(period === 'year') return eDate.getFullYear() === now.getFullYear();
                if(period === 'month') return eDate.getMonth() === now.getMonth() && eDate.getFullYear() === now.getFullYear();
                if(period === 'week') {
                    const diff = (now - eDate) / (1000 * 60 * 60 * 24);
                    return diff <= 7;
                }
            });

            document.getElementById('stat-total').innerText = filtered.length;
            
            let peopleCount = {};
            let placeCount = {};
            let eventCount = {};
            let uniquePeople = new Set();

            filtered.forEach(e => {
                placeCount[e.place] = (placeCount[e.place] || 0) + 1;
                eventCount[e.event] = (eventCount[e.event] || 0) + 1;
                e.people.forEach(p => {
                    peopleCount[p] = (peopleCount[p] || 0) + 1;
                    uniquePeople.add(p);
                });
            });

            document.getElementById('stat-unique-people').innerText = uniquePeople.size;

            let html = renderRankSection("üèÜ Top Personnes", peopleCount);
            html += renderRankSection("üìç Top Lieux", placeCount);
            html += renderRankSection("üé´ Top √âv√©nements", eventCount);
            
            document.getElementById('stats-rankings').innerHTML = html;
        }

        function renderRankSection(title, data) {
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 5);
            if(sorted.length === 0) return "";
            return `<div style="margin-top:20px"><strong>${title}</strong></div>` + 
                   sorted.map(item => `<div class="ranking-item"><span>${item[0]}</span><span>${item[1]} fois</span></div>`).join('');
        }

        init();
    </script>
</body>
</html>
